# 今日总结（TRELLIS · WSL2 · image-to-3D 调试）

## 环境与基础信息

* 平台：WSL2（NAT 网络），Windows GPU 直通
* Python：3.10（conda 环境 `trellis`）
* 关键三方库（已验证可导入）：`spconv`、`nvdiffrast`、`kaolin`、`xformers`
* 模型与缓存：

  * `TRELLIS_MODEL_ID=/mnt/d/models/TRELLIS-image-large`（本地离线目录，含 `pipeline.json` 与 `ckpts/*.safetensors`）
  * `DINOV2_DIR=/mnt/d/hf_cache/hub/facebookresearch_dinov2_main`（离线 dinov2 代码）
  * `TORCH_HOME=/mnt/d/hf_cache`
* 运行选项：

  * `ATTN_BACKEND=xformers`，`SPCONV_ALGO=native`
  * 统一设置离线：`HF_HUB_OFFLINE=1`、`TRANSFORMERS_OFFLINE=1`

---

## 今日主要尝试（命令/参数）

```bash
# 离线 CLI 路径（首选，避开 Gradio schema 问题）
export TRELLIS_MODEL_ID="/mnt/d/models/TRELLIS-image-large"
export DINOV2_DIR="/mnt/d/hf_cache/hub/facebookresearch_dinov2_main"
export HF_HUB_OFFLINE=1 TRANSFORMERS_OFFLINE=1
export TORCH_HOME=/mnt/d/hf_cache
export ATTN_BACKEND=xformers SPCONV_ALGO=native
python -u run_cli.py /mnt/d/your_image.jpg
```

安装/构建渲染依赖（为 Gaussian 渲染做准备）：

```bash
# 解压从 Windows 下载的 DGR 源码包
sudo apt-get update && sudo apt-get install -y unzip ninja-build build-essential
unzip /mnt/d/src/diff-gaussian-rasterization-main.zip -d /mnt/d/src/
cd /mnt/d/src/diff-gaussian-rasterization-main
pip install -U pip wheel setuptools
# 构建（首次失败，见下方错误）
pip install --no-build-isolation -v .
```

应急脚本（绕过 Gaussian，直接渲染 mesh）：

```bash
# 新增 run_cli_mesh.py（调用 outs['mesh'] 渲染）
pip install imageio easydict
python -u run_cli_mesh.py /mnt/d/your_image.jpg
```

---

## 观察到的错误与堆栈

1. **Gaussian 渲染阶段缺库**

```
ModuleNotFoundError: No module named 'diff_gaussian_rasterization'
```

2. **本地编译 DGR 失败（ninja）**

```
subprocess.CalledProcessError: Command '['ninja', '-v']' returned non-zero exit status 1
RuntimeError: Error compiling objects for extension
ERROR: Failed building wheel for diff_gaussian_rasterization
```

后续导入：

```
ImportError: cannot import name '_C' ... from partially initialized module
```

（构建未产出 `.so` 扩展，导入失败）

3. **内置 Gaussian 渲染 API 形参不兼容**

```
TypeError: GaussianRasterizationSettings.__new__() got an unexpected keyword argument 'kernel_size'
```

（说明当前 DGR 版本与 TRELLIS 里调用签名不一致）

4. **在线加载测试（仅验证）**

```
ImportError: libcudart.so.12: cannot open shared object file
RepositoryNotFoundError: ... /ckpts/ss_flow_img_dit_L_16l8_fp16/.json (404)
```

（在线路径会触发 FlashAttention 的 CUDA 运行时与私有 ckpts 访问；确认继续坚持离线路径）

---

## 怀疑的根因

* **DGR 构建环境不完整/不匹配**

  * 需要系统级 CUDA toolchain（`CUDA_HOME`、`nvcc`）、`ninja-build`、兼容的 `gcc/g++`。WSL 内通常未装完整 CUDA Toolkit，仅有 PyTorch 的运行时。
  * PyTorch-CUDA 版本与本机 CUDA Toolkit 不一致也会导致 C++/CUDA 扩展无法编译。
* **DGR 版本与 TRELLIS 的调用签名存在差异**

  * TRELLIS 使用了 `GaussianRasterizationSettings(kernel_size=...)`；部分 DGR 分支/旧版不支持该参数。
* **在线 fallback 不可行**

  * WSL 的代理/网络限制 + 上游仓库为私有/不存在的 ckpts，导致在线自动拉取无法作为兜底方案。

---

## 今日已生效的修复/进展

* ✅ **完全离线加载主模型**：通过本地 `pipeline.json` + safetensors，`dinov2` 设为本地目录，`xformers` 成功启用；**采样阶段可顺利跑完**（`Sampling 25/25`）。
* ✅ **绕过 Gradio schema 报错**：不走 `app.py`/WebUI，改走 `run_cli.py`（CLI）；Web 相关 `Cannot parse schema True` 问题对 CLI 不影响。
* ✅ **应急渲染路径准备**：新增 `run_cli_mesh.py`，并补齐 `imageio`、`easydict`，为 **直接渲染 mesh** 做好铺垫。

---

## 仍未解决 / 阻塞项

* ⛔ **`diff_gaussian_rasterization` 未能编译通过**（ninja 报错，缺 `_C` 扩展）
* ⛔ **API 不兼容**：即便编过一个版本，若不支持 `kernel_size` 参数，仍会在 TRELLIS 的 Gaussian 渲染处报错
* ⛔ **WebUI** 仍存在 `gradio_client` 的 schema 解析异常（但当前优先使用 CLI，不影响功能验证）

---


## 当前结论（今日收尾）

* **模型推理主干已通（采样阶段跑通）**，问题集中在 **Gaussian 渲染依赖（DGR）构建与 API 兼容**。
* 可立即走 **mesh 渲染** 路线拿到可视结果；并行推进 **DGR 的本地编译** 与 **调用形参兼容**，预计能恢复 Gaussian 预览与导出。
