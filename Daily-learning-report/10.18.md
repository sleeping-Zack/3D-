
## 🧩 今日总结｜TRELLIS 本地运行与 CUDA/MSVC 环境修复全过程

### 🧱 一、核心目标

让 **TRELLIS-for-windows-2.0** 项目在本地正确运行，实现从图像到 3D 模型的生成，并修复所有 CUDA / C++ 扩展编译相关问题。

---

### ⚙️ 二、主要问题与进展

#### 1️⃣ CUDA 环境配置与 `CUDA_HOME`

* 确认了自己的显卡为 **RTX 4060 Laptop GPU**、驱动版本 32.0.15.6624。
* 安装了 **CUDA 12.4**，并通过：

  ```bash
  setx CUDA_HOME "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
  setx PATH "%PATH%;%CUDA_HOME%\bin;%CUDA_HOME%\libnvvp"
  ```

  成功配置系统环境变量。
  ✅ CUDA 环境准备完毕。

---

#### 2️⃣ Visual Studio 编译环境缺失

* `nvdiffrast` 报错：

  ```
  RuntimeError: Could not locate a supported Microsoft Visual C++ installation
  ```

  说明 PyTorch 无法找到 MSVC 编译器。

* 安装了 **Visual Studio Build Tools 2022 (v17.14)**，
  找到了 `vcvars64.bat` 路径：

  ```
  D:\Microsoft Visual Studio\VC\Auxiliary\Build\vcvars64.bat
  ```

  ✅ 手动执行后可 `where cl` 正常输出 MSVC 路径。

---

#### 3️⃣ CMD 启动环境修复

发现问题出在：最初运行 `python app.py` 的窗口**没有加载 vcvars64.bat** 的环境变量。
在执行以下命令后修复：

```bash
"D:\Microsoft Visual Studio\VC\Auxiliary\Build\vcvars64.bat"
cd /d D:\TRELLIS-for-windows-2.0
.\.venv\Scripts\activate
python app.py
```

✅ 成功加载 MSVC、虚拟环境与 CUDA。

---

#### 4️⃣ 编译阶段的 UnicodeDecodeError

`ninja` 编译输出乱码，Python 无法 decode。
通过添加以下命令解决：

```bash
set PYTHONIOENCODING=utf-8
set PYTHONUTF8=1
set TORCH_CUDA_ARCH_LIST=8.9
```

✅ 防止编码错误与多架构编译冲突。

---

#### 5️⃣ MSVC 版本兼容性问题

虽然 `cl.exe` 已能识别，但 PyTorch 的内部检测逻辑只识别旧版（14.3x）路径结构。
出现：

```
RuntimeError: Could not locate a supported Microsoft Visual C++ installation
```

原因：
我的 MSVC 是 **v14.44 (VS2022 v17.14)**，PyTorch 只支持 ≤ v14.38。

解决方案两种：

* 临时方案：

  ```bash
  set DISTUTILS_USE_SDK=1
  set MSSdk=1
  set PATH=%PATH%;D:\Microsoft Visual Studio\VC\Tools\MSVC\14.44.35207\bin\Hostx64\x64
  python app.py
  ```
* 永久方案：
  通过 Visual Studio Installer 安装旧版 MSVC v14.38 编译工具。

---

### 💡 三、环境验证结果

✅ CUDA：可正常识别 GPU
✅ MSVC：可通过 `where cl` 检测
✅ Python：虚拟环境加载成功
⚠️ `nvdiffrast`：仍需 MSVC 兼容层（PyTorch 与 VS2022 新版路径问题）
💬 后续：准备安装旧版 MSVC v14.38 或手动指定编译器路径。

---

### 🔧 四、推荐的最终启动脚本

（可放在 `D:\TRELLIS-for-windows-2.0\start_trellis.bat`）

```bat
@echo off
call "D:\Microsoft Visual Studio\VC\Auxiliary\Build\vcvars64.bat"
cd /d D:\TRELLIS-for-windows-2.0
call .\.venv\Scripts\activate
set DISTUTILS_USE_SDK=1
set MSSdk=1
set PYTHONIOENCODING=utf-8
set PYTHONUTF8=1
set TORCH_CUDA_ARCH_LIST=8.9
python app.py
pause
```

✅ 双击启动即可一次性加载所有环境并运行 TRELLIS。

---

### 🚀 五、今日成果总结

| 阶段                 | 问题                   | 解决结果               |
| ------------------ | -------------------- | ------------------ |
| CUDA 环境            | 缺少路径变量               | ✅ 已修复              |
| VS 环境              | 没有 vcvars64.bat      | ✅ 已找到              |
| Python 虚拟环境        | 未激活路径错误              | ✅ 已修复              |
| nvdiffrast 编译      | 缺失 MSVC 环境           | ✅ 已加载 vcvars64.bat |
| UnicodeDecodeError | 控制台编码不兼容             | ✅ 已解决              |
| 仍存问题               | PyTorch 不识别新 MSVC 结构 | ⚠️ 待解决（可装 v14.38）  |

---

